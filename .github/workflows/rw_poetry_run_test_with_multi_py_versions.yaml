#################################################################################################################################
#
# Workflow Description:
#     Use Poetry to run testing by specific type with all test items via PyTest and generate its testing
#     coverage report (it would save reports by 'actions/upload-artifact@v3').
#
# Workflow input parameters:
#     * test_type: The testing type. In generally, it only has 2 options: 'unit-test' and 'integration-test'.
#     * install_dependency_with_group: Install the dependency by Poetry configuration with dependency group setting. This parameter receive the dependency group naming.
#     * all_test_items_paths: The target paths of test items under test.
#
# Workflow running output:
#     No, but it would save the testing coverage reports to provide after-process to organize and record.
#
#     * Upload-Artifact:
#         * coverage: The test coverage report which be generated by PyTest, and it's recorded after run test done.
#                           The file name format would be .coverage.<test type>.<runtime os>-<python-version>
#
#################################################################################################################################

name: Run test items via PyTest

# TODO: Run Python package test via Poetry.

on:
  workflow_call:
    inputs:
      test_type:
        description: "The testing type. In generally, it only has 2 options: 'unit-test' and 'integration-test'."
        required: true
        type: string
      install_dependency_with_group:
        description: "Install the dependency by Poetry configuration with dependency group setting. This parameter receive the dependency group naming."
        type: string
        required: false
        default: ''
      all_test_items_paths:
        description: "The target paths of test items under test."
        required: true
        type: string

# TODO: Add a reusable workflow about running test via Poetry
# TODO: https://github.com/marketplace/actions/python-poetry-action

jobs:
  run_test_items:
    strategy:
      matrix:
        python-version: [3.9,'3.10','3.11','3.12','3.13']
        os: [ubuntu-latest,ubuntu-20.04,macos-latest,macos-13]
        test-path: ${{fromJson(inputs.all_test_items_paths)}}
      fail-fast: false    # Fix issue in GitHub Action: FailFast: cancelling since parallel instance has failed

    uses: ./.github/workflows/rw_poetry_run_test.yaml
    with:
      runtime_os: ${{ matrix.os }}
      python_version: ${{ matrix.python-version }}
      test_type: ${{ inputs.test_type }}
      install_dependency_with_group: ${{ inputs.install_dependency_with_group }}
      all_test_items_paths: ${{ inputs.all_test_items_paths }}
